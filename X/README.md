# FileManager — Документация проекта

## Краткое описание

**FileManager** (также называется **Fi2** или **Finder**) — веб-приложение для управления и мониторинга файлов в файловой системе. Система автоматически сканирует указанные директории, отслеживает изменения файлов (добавление, удаление, перемещение, обновление) и предоставляет удобный интерфейс для просмотра, поиска и управления файлами.

Проект написан на **PHP** с использованием **PostgreSQL** в качестве базы данных и **JavaScript** для интерактивности на клиенте.

---

## Основные возможности

### 1. Сканирование файловой системы
- Автоматическое сканирование указанных директорий
- Инкрементальное сканирование (только изменения)
- Отслеживание статусов файлов: новый, активный, удалённый, перемещённый, обновлённый
- Определение перемещённых файлов по имени и размеру
- Игнорирование определённых расширений (например, `.reapeaks`)

### 2. Управление файлами
- Просмотр списка всех файлов с фильтрацией и поиском
- Детальная информация о каждом файле:
  - Имя, размер, путь
  - Статус файла
  - Даты создания и модификации (из файловой системы)
  - Даты добавления и обновления в БД
  - История перемещений
- Открытие папки с файлом в проводнике Windows
- Пагинация с кнопкой "Загрузить еще"

### 3. Метаданные видео
- Автоматическое извлечение метаданных из видеофайлов через `ffprobe`
- Отображение информации:
  - Длительность
  - Разрешение и соотношение сторон
  - FPS (кадры в секунду)
  - Битрейт
  - Видео и аудио кодеки
  - Количество аудиоканалов
  - Язык
  - Наличие субтитров
- Генерация превью (thumbnail) для видео
- Воспроизведение видео прямо в интерфейсе

### 4. Управление клиентами
- Добавление, редактирование и удаление клиентов
- Привязка файлов к клиентам
- Отображение количества файлов у каждого клиента
- Фильтрация файлов по клиенту

### 5. История изменений
- Полная история всех изменений файлов
- Фильтрация по типу изменения (добавлено, удалено, перемещено, обновлено)
- Фильтрация по дате
- Поиск по имени файла или пути
- Визуальное отображение изменений путей
- Статистика изменений

### 6. Поиск и фильтрация
- Поиск по имени файла (регистронезависимый)
- Фильтрация по статусу файла
- Фильтрация по клиенту
- Сортировка:
  - По дате (новые/старые)
  - По размеру (по возрастанию/убыванию)
  - По имени (A→Z / Z→A)

### 7. Администрирование
- Управление путями для сканирования
- Запуск сканирования вручную
- Очистка таблицы файлов (TRUNCATE CASCADE)
- Просмотр статистики сканирований

---

## Архитектура проекта

### Структура директорий

```
/
├── api/                    # API endpoints для AJAX запросов
│   ├── ajax_clients.php    # Управление клиентами
│   ├── ajax_scan.php       # Запуск сканирования и проверка статуса
│   ├── get_file_info.php   # Получение информации о файле
│   ├── get_video_metadata.php  # Извлечение метаданных видео
│   ├── get-scan-details.php     # Детали последнего скана
│   ├── load_more_files.php     # Пагинация файлов
│   └── stream_video.php        # Стриминг видеофайлов
│
├── bc/                    # Backend компоненты (бизнес-логика)
│   ├── filter_sort.php    # Построение SQL-запросов с фильтрацией
│   ├── fldr_open.php      # Открытие папки в проводнике Windows
│   └── scanner2.php       # Основной модуль сканирования
│
├── db/                    # Работа с базой данных
│   └── db_connect.php     # Подключение к PostgreSQL
│
├── includes/              # Включаемые компоненты
│   ├── overlays.php       # Модальные окна (инфо о файле, привязка клиента)
│   └── sidebar.php        # Боковое меню навигации
│
├── pages/                 # Страницы приложения
│   ├── admin.php          # Панель администратора
│   ├── clients.php        # Управление клиентами
│   ├── dashboard2.php    # Главная страница (список файлов)
│   └── history.php        # История изменений
│
├── thumbnails/            # Превью видеофайлов (saved)
│
├── index.php              # Точка входа (роутер)
├── script.js              # JavaScript для клиентской части
└── style.css              # Стили интерфейса
```

### Ключевые файлы

#### `index.php`
- Точка входа в приложение
- Роутинг страниц через GET-параметр `?page=`
- Подключение необходимых компонентов
- Проверка безопасности (белый список разрешённых страниц)

#### `bc/scanner2.php`
- Функция `runIncrementalScan(PDO $pdo)` — основной алгоритм сканирования
- Сравнение снимка файловой системы с данными в БД
- Определение новых, удалённых, перемещённых и обновлённых файлов
- Запись изменений в таблицу `file_changes`
- Функция `normalizeWindowsPath()` — нормализация путей для Windows

#### `pages/dashboard2.php`
- Главная страница со списком файлов
- Построение SQL-запросов с фильтрацией
- Отображение статистики (общее количество файлов, объём в GB)
- Таблица файлов с пагинацией

#### `api/ajax_scan.php`
- Обработка POST-запроса для запуска сканирования
- Проверка статуса сканирования через GET `?check_status=1`
- Использование сессий для предотвращения параллельных сканов
- Возврат статистики сканирования в JSON

#### `script.js`
- Клиентская логика интерфейса
- AJAX-запросы для динамической загрузки данных
- Управление модальными окнами
- Обработка событий (клики, формы, фильтры)

---

## База данных

### Общая информация

Проект использует **PostgreSQL** в качестве системы управления базами данных. База данных хранит информацию о файлах, путях сканирования, клиентах, истории изменений и метаданных видео. Все изменения схемы БД выполняются напрямую через SQL-команды в pgAdmin, без использования ORM или миграций.

### Назначение базы данных

База данных FileManager решает следующие задачи:
- **Хранение метаданных файлов** — информация о всех файлах в сканируемых директориях
- **Отслеживание изменений** — полная история добавлений, удалений, перемещений и обновлений файлов
- **Управление источниками** — список директорий для сканирования
- **Связь с клиентами** — привязка файлов к клиентам для организации работы
- **Метаданные видео** — техническая информация о видеофайлах (разрешение, кодек, длительность и т.д.)
- **История сканирований** — статистика и результаты каждого сканирования

### Структура таблиц

#### Таблица `scan_paths` (пути для сканирования)

Хранит список директорий, которые должны сканироваться системой.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | SERIAL PRIMARY KEY | Уникальный идентификатор пути |
| `path` | TEXT NOT NULL UNIQUE | Абсолютный путь к директории для сканирования |
| `is_active` | BOOLEAN DEFAULT true | Флаг активности пути (не используется в коде) |
| `description` | TEXT | Описание пути (не используется в коде) |
| `created_at` | TIMESTAMP DEFAULT CURRENT_TIMESTAMP | Дата создания записи |
| `last_scanned_at` | TIMESTAMP NULL | Время последнего сканирования этого пути |
| `full_scan_completed` | BOOLEAN DEFAULT false | Флаг завершения полного скана (не используется) |
| `last_full_scan_at` | TIMESTAMP | Дата последнего полного скана (не используется) |
| `last_quick_scan_at` | TIMESTAMP | Дата последнего быстрого скана (не используется) |

**Связи:**
- `files.scan_path_id` → `scan_paths.id` (один путь может содержать много файлов)

**Использование:**
- Загрузка путей для сканирования в `bc/scanner2.php`
- Добавление/удаление путей через админ-панель (`pages/admin.php`)
- Обновление `last_scanned_at` после завершения сканирования

#### Таблица `files` (основная информация о файлах)

Центральная таблица системы, хранит метаданные всех отслеживаемых файлов.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | SERIAL PRIMARY KEY | Уникальный идентификатор файла |
| `scan_path_id` | INTEGER REFERENCES scan_paths(id) | Связь с источником сканирования |
| `file_path` | TEXT NOT NULL UNIQUE | Полный путь к файлу в файловой системе |
| `file_name` | VARCHAR(500) NOT NULL | Имя файла (без пути) |
| `file_extension` | VARCHAR(50) | Расширение файла (например, `.mp4`) |
| `file_size` | BIGINT | Размер файла в байтах |
| `file_hash` | VARCHAR(64) NULL | Хеш файла для поиска дубликатов (не используется) |
| `file_status` | VARCHAR(20) DEFAULT 'new' | Текущий статус: `new`, `active`, `deleted`, `moved`, `updated`, `source_off` |
| `temp_found` | BOOLEAN DEFAULT false | Временный флаг: найден ли файл в текущем скане |
| `client_id` | INTEGER REFERENCES clients(id) ON DELETE SET NULL | Привязка к клиенту (опционально) |
| `file_created_at` | TIMESTAMP NULL | Дата создания файла (из файловой системы) |
| `file_modified_at` | TIMESTAMP NULL | Дата последней модификации (из файловой системы) |
| `created_at` | TIMESTAMP DEFAULT CURRENT_TIMESTAMP | Дата добавления записи в БД |
| `updated_at` | TIMESTAMP DEFAULT CURRENT_TIMESTAMP | Дата последнего обновления записи |
| `last_seen_mtime` | BIGINT | Unix timestamp последнего изменения (не используется) |
| `mtime` | BIGINT | Unix timestamp модификации (не используется) |
| `partial_hash` | VARCHAR(32) | Частичный хеш для быстрого сравнения (не используется) |

**Связи:**
- `files.scan_path_id` → `scan_paths.id` (многие файлы принадлежат одному пути)
- `files.client_id` → `clients.id` (многие файлы могут быть привязаны к одному клиенту)
- `video_metadata.file_id` → `files.id` (один файл может иметь метаданные видео)
- `file_changes.file_id` → `files.id` (один файл может иметь много записей в истории)

**Использование:**
- Основная таблица для отображения списка файлов на главной странице
- Фильтрация и поиск по имени, статусу, клиенту
- Отслеживание изменений через сравнение с файловой системой
- Хранение оригинальных дат создания и модификации из ФС

#### Таблица `clients` (клиенты)

Хранит информацию о клиентах, к которым можно привязывать файлы.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | SERIAL PRIMARY KEY | Уникальный идентификатор клиента |
| `name` | TEXT NOT NULL | Название/имя клиента |
| `phone` | VARCHAR(50) | Номер телефона (опционально) |
| `email` | VARCHAR(100) | Email адрес (опционально) |
| `color` | VARCHAR(7) DEFAULT NULL | Цвет для выделения клиента (не используется) |
| `created_at` | TIMESTAMP DEFAULT CURRENT_TIMESTAMP | Дата создания записи |
| `updated_at` | TIMESTAMP DEFAULT CURRENT_TIMESTAMP | Дата последнего обновления |

**Связи:**
- `files.client_id` → `clients.id` (один клиент может иметь много файлов)

**Использование:**
- Управление клиентами через страницу `pages/clients.php`
- Фильтрация файлов по клиенту на главной странице
- Отображение имени клиента в таблице файлов

#### Таблица `video_metadata` (метаданные видео)

Хранит техническую информацию о видеофайлах, извлечённую через `ffprobe`.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | SERIAL PRIMARY KEY | Уникальный идентификатор записи |
| `file_id` | INTEGER REFERENCES files(id) ON DELETE CASCADE UNIQUE | Связь с файлом (один к одному) |
| `duration` | INTEGER | Длительность в секундах |
| `width` | INTEGER | Ширина видео в пикселях |
| `height` | INTEGER | Высота видео в пикселях |
| `resolution` | VARCHAR(20) | Разрешение (например, "1920×1080") |
| `fps` | DECIMAL(5,2) | Кадров в секунду |
| `bitrate` | BIGINT | Битрейт в битах в секунду |
| `codec_video` | VARCHAR(50) | Видео кодек (например, "H.264") |
| `codec_audio` | VARCHAR(50) | Аудио кодек (например, "AAC") |
| `audio_channels` | INTEGER | Количество аудиоканалов |
| `aspect_ratio` | VARCHAR(20) | Соотношение сторон (например, "16:9") |
| `language` | VARCHAR(10) | Язык аудиодорожки |
| `subtitles` | BOOLEAN DEFAULT false | Наличие субтитров |
| `thumbnail_path` | TEXT | Путь к превью (thumbnail) видео |
| `created_at` | TIMESTAMP DEFAULT CURRENT_TIMESTAMP | Дата создания записи |

**Связи:**
- `video_metadata.file_id` → `files.id` (каждое видео имеет одну запись метаданных)

**Использование:**
- Извлечение метаданных через `api/get_video_metadata.php` при открытии информации о видеофайле
- Кэширование метаданных для избежания повторного вызова `ffprobe`
- Отображение в боковой панели информации о файле

#### Таблица `scan_history` (история сканирований)

Хранит информацию о каждом запуске сканирования.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | SERIAL PRIMARY KEY | Уникальный идентификатор скана |
| `scan_path_id` | INTEGER REFERENCES scan_paths(id) | Связь с путём сканирования (не используется) |
| `scan_started_at` | TIMESTAMP NOT NULL | Время начала сканирования |
| `scan_finished_at` | TIMESTAMP | Время завершения сканирования |
| `files_found` | INTEGER DEFAULT 0 | Количество найденных файлов |
| `files_added` | INTEGER DEFAULT 0 | Количество новых файлов |
| `files_updated` | INTEGER DEFAULT 0 | Количество обновлённых файлов |
| `files_deleted` | INTEGER DEFAULT 0 | Количество удалённых файлов |
| `files_moved` | INTEGER DEFAULT 0 | Количество перемещённых файлов |
| `status` | VARCHAR(20) | Статус: `running`, `success`, `error` |
| `error_message` | TEXT | Сообщение об ошибке (если статус `error`) |
| `scan_type` | VARCHAR(10) DEFAULT 'quick' | Тип скана: `quick` или `full` (не используется) |

**Связи:**
- `scan_history.scan_path_id` → `scan_paths.id` (один путь может иметь много сканов)
- `file_changes.scan_history_id` → `scan_history.id` (один скан содержит много изменений)

**Использование:**
- Создание записи в начале сканирования (`bc/scanner2.php`)
- Обновление статистики и статуса после завершения
- Получение деталей последнего скана через `api/get-scan-details.php`
- Отображение времени последнего скана в интерфейсе

#### Таблица `file_changes` (детальная история изменений)

Хранит подробную информацию о каждом изменении файла.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | SERIAL PRIMARY KEY | Уникальный идентификатор изменения |
| `scan_history_id` | INTEGER REFERENCES scan_history(id) ON DELETE CASCADE | Связь со сканом, в котором произошло изменение |
| `file_id` | INTEGER REFERENCES files(id) | Связь с файлом |
| `change_type` | VARCHAR(20) | Тип изменения: `added`, `deleted`, `moved`, `updated`, `restored` |
| `old_path` | TEXT | Старый путь (для перемещений и удалений) |
| `new_path` | TEXT | Новый путь (для добавлений и перемещений) |
| `changed_at` | TIMESTAMP DEFAULT CURRENT_TIMESTAMP | Время изменения |
| `details` | JSONB | Дополнительные детали (например, старый и новый размер для обновлений) |

**Связи:**
- `file_changes.scan_history_id` → `scan_history.id` (много изменений в одном скане)
- `file_changes.file_id` → `files.id` (один файл может иметь много изменений)

**Использование:**
- Запись всех изменений во время сканирования (`bc/scanner2.php`)
- Отображение истории на странице `pages/history.php`
- Фильтрация по типу изменения, дате, поиск по путям

### Индексы базы данных

Индексы созданы для ускорения поиска и фильтрации данных.

#### Индексы для таблицы `files`

- **`idx_files_name`** — поиск по имени файла
- **`idx_files_name_pattern`** — поиск по шаблону имени (text_pattern_ops)
- **`idx_files_extension`** — фильтрация по расширению
- **`idx_files_status`** — фильтрация по статусу
- **`idx_files_created_at`** — сортировка по дате создания
- **`idx_files_updated_at`** — сортировка по дате обновления
- **`idx_files_size`** — сортировка по размеру
- **`idx_files_path`** — быстрый поиск по пути (критично для сканирования)
- **`idx_files_scan_path_id`** — фильтрация по источнику сканирования
- **`idx_files_client_id`** — фильтрация по клиенту
- **`idx_files_status_created`** — составной индекс для фильтрации по статусу и сортировки по дате
- **`idx_files_name_size`** — составной индекс по имени и размеру
- **`idx_files_temp_found`** — частичный индекс для файлов с `temp_found = false` (ускорение поиска не найденных файлов)

#### Индексы для других таблиц

- **`idx_video_metadata_file_id`** — быстрый поиск метаданных по файлу
- **`idx_video_metadata_resolution`** — фильтрация по разрешению
- **`idx_video_metadata_duration`** — фильтрация по длительности
- **`idx_file_changes_scan_history`** — поиск изменений по скану
- **`idx_file_changes_file_id`** — поиск изменений по файлу



### Логика работы с базой данных

#### Процесс сканирования

1. **Создание записи скана** — в `scan_history` создаётся запись со статусом `running`
2. **Сброс флагов** — все файлы из сканируемых путей получают `temp_found = false`
3. **Сканирование ФС** — рекурсивный обход директорий, сбор информации о файлах
4. **Сравнение** — сравнение снимка ФС с данными в БД:
   - Файл найден по пути → проверка размера, обновление `temp_found = true`
   - Файл найден по имени+размеру, но путь другой → перемещение
   - Файл не найден в БД → новый файл
   - Файл есть в БД, но не найден в ФС → удалён
5. **Применение изменений** — массовые INSERT/UPDATE в таблице `files`
6. **Логирование** — запись всех изменений в `file_changes`
7. **Завершение** — обновление `scan_history` со статистикой и статусом `success`

#### Связь файлов с клиентами

- Файл может быть привязан к клиенту через поле `client_id`
- При удалении клиента (`ON DELETE SET NULL`) связь с файлами разрывается, но файлы остаются
- Фильтрация файлов по клиенту выполняется через JOIN с таблицей `clients`

#### Хранение метаданных видео

- Метаданные извлекаются один раз при первом запросе через `ffprobe`
- Сохраняются в `video_metadata` для кэширования
- При повторном запросе данные берутся из БД, без повторного вызова `ffprobe`
- Thumbnail генерируется через `ffmpeg` и сохраняется в директории `thumbnails/`

---

## Установка и запуск

### Требования

1. **Веб-сервер** с поддержкой PHP (например, XAMPP, Apache, Nginx)
2. **PHP 7.4+** с расширениями:
   - `pdo_pgsql` (для работы с PostgreSQL)
   - `json`
   - `mbstring`
3. **PostgreSQL** (версия 9.6+)
4. **FFmpeg** (опционально, для работы с видео):
   - `ffprobe` — для извлечения метаданных
   - `ffmpeg` — для генерации превью
   - Путь к исполняемым файлам должен быть указан в `api/get_video_metadata.php`

### Шаги установки

1. **Клонирование/копирование проекта**
   ```bash
   # Скопируйте проект в директорию веб-сервера
   # Например, для XAMPP: /Applications/XAMPP/xamppfiles/htdocs/3/
   ```

2. **Настройка базы данных**
   
   Создайте базу данных PostgreSQL и выполните SQL-скрипты для создания таблиц:
   
   ```sql
   -- Пример структуры таблиц (на основе кода)
   -- ВАЖНО: Точная структура БД не указана в коде, 
   -- но предполагаются следующие таблицы:
   
   -- scan_paths (пути для сканирования)
   -- files (информация о файлах)
   -- clients (клиенты)
   -- file_changes (история изменений)
   -- scan_history (история сканирований)
   -- video_metadata (метаданные видео)
   ```

3. **Настройка подключения к БД**
   
   Отредактируйте файл `db/db_connect.php`:
   ```php
   $host = 'localhost';
   $dbname = 'file_manager';
   $user = 'postgres';
   $password = 'zxc';
   ```

4. **Настройка FFmpeg** (если нужна работа с видео)
   
   Отредактируйте `api/get_video_metadata.php`:
   ```php
   $ffprobePath = 'C:\Users\praktikants\Desktop\ffmpeg\bin\ffprobe.exe';
   $ffmpegPath = 'C:\Users\praktikants\Desktop\ffmpeg\bin\ffmpeg.exe';
   ```
   Укажите правильные пути к исполняемым файлам FFmpeg на вашей системе.

5. **Права доступа**
   
   Убедитесь, что веб-сервер имеет права на:
   - Чтение файлов в сканируемых директориях
   - Запись в директорию `thumbnails/` (для превью видео)

6. **Запуск**
   
   Откройте в браузере:
   ```
   http://localhost/3/
   ```

---

## Конфигурация

### Пути для сканирования

Пути настраиваются через интерфейс администратора (`?page=admin`):
- Добавление нового пути через форму
- Удаление пути (при удалении все файлы из этого пути получают статус `source_off`)

### Игнорируемые расширения

В файле `bc/scanner2.php` указан список игнорируемых расширений:
```php
$ignoredExtensions = ['reapeaks'];
```

Для добавления других расширений отредактируйте этот массив.

### Лимиты сканирования

В `bc/scanner2.php` установлены лимиты:
```php
set_time_limit(1200);  // 20 минут
ini_set('memory_limit', '512M');
```

При необходимости увеличьте эти значения для больших объёмов данных.

### Пагинация

- На главной странице: 20 файлов на страницу
- В истории: 20 событий на страницу
- Настраивается в соответствующих PHP-файлах

---

## Примеры использования

### 1. Первый запуск

1. Откройте страницу администратора: `?page=admin`
2. Добавьте путь для сканирования (например, `C:\Users\Documents\Videos`)
3. Нажмите "Запустить сканирование"
4. Дождитесь завершения сканирования
5. Перейдите на главную страницу (`?page=dashboard`) для просмотра файлов

### 2. Поиск файла

1. На главной странице введите имя файла в поле поиска
2. Нажмите "Найти" или дождитесь автоматической отправки формы
3. Результаты отобразятся в таблице

### 3. Просмотр информации о файле

1. В таблице файлов нажмите кнопку с иконкой "info"
2. Откроется боковая панель с детальной информацией
3. Для видеофайлов автоматически загрузятся метаданные
4. Клик по превью видео запустит воспроизведение

### 4. Привязка файла к клиенту

1. В таблице файлов нажмите кнопку с иконкой "people"
2. В модальном окне выберите клиента из списка
3. Нажмите "Сохранить"
4. Файл будет привязан к выбранному клиенту

### 5. Фильтрация файлов

1. Используйте выпадающие списки фильтров:
   - **Статус**: Ок, Новый, Удален, Перемещен, Обновлен, Источник отключен
   - **Сортировка**: По дате, размеру, имени
   - **Клиент**: Выберите конкретного клиента
2. Фильтры применяются автоматически при изменении

### 6. Просмотр истории изменений

1. Перейдите на страницу "История" (`?page=history`)
2. Используйте фильтры для поиска конкретных событий:
   - Тип изменения (добавлено, удалено, перемещено, обновлено)
   - Период (дата от/до)
   - Поиск по имени или пути
3. Для перемещённых файлов отображается визуальное сравнение путей

---

## Основные классы и функции

### PHP

#### `runIncrementalScan(PDO $pdo)`
**Файл:** `bc/scanner2.php`

Основная функция сканирования файловой системы.

**Алгоритм работы:**
1. Загружает пути для сканирования из БД
2. Сбрасывает флаг `temp_found` для всех файлов из этих путей
3. Загружает снимок файлов из БД
4. Создаёт снимок файловой системы (рекурсивный обход директорий)
5. Сравнивает снимки:
   - Файл найден по тому же пути → проверка размера, обновление статуса
   - Файл найден по имени и размеру, но путь другой → перемещение
   - Файл не найден в БД → новый файл
   - Файл есть в БД, но не найден в ФС → удалён
6. Применяет изменения в БД (INSERT, UPDATE)
7. Записывает историю изменений в `file_changes`
8. Обновляет запись в `scan_history`

**Возвращает:**
```php
[
    'status' => 'success',
    'stats' => [
        'new' => 10,
        'updated' => 5,
        'moved' => 2,
        'deleted' => 3
    ],
    'scan_id' => 123
]
```

#### `buildFilters(array $params): array`
**Файл:** `bc/filter_sort.php`

Строит SQL-запрос с условиями WHERE и ORDER BY на основе параметров фильтрации.

**Параметры:**
- `search` — поиск по имени файла
- `status` — фильтр по статусу
- `client_id` — фильтр по клиенту
- `sort` — тип сортировки

**Возвращает:**
```php
[
    'where' => 'WHERE file_name ILIKE :search AND file_status = :status',
    'order_by' => 'created_at DESC',
    'bindings' => [':search' => '%test%', ':status' => 'active']
]
```

### JavaScript

#### `startScan(btn)`
**Файл:** `script.js`

Запускает сканирование через AJAX.

**Процесс:**
1. Блокирует кнопку сканирования
2. Отправляет POST-запрос на `api/ajax_scan.php`
3. Отображает статистику результатов
4. Обновляет время последнего скана
5. Разблокирует кнопку

#### `loadFileAndShowInfo(buttonElement, fileId)`
**Файл:** `script.js`

Загружает информацию о файле и отображает в боковой панели.

**Процесс:**
1. Отправляет GET-запрос на `api/get_file_info.php?id={fileId}`
2. Форматирует данные
3. Вызывает `showFileInfo()` для отображения
4. Для видеофайлов вызывает `loadVideoMetadata()`

#### `loadVideoMetadata(fileId, filePath)`
**Файл:** `script.js`

Загружает метаданные видео через `api/get_video_metadata.php`.

**Особенности:**
- Показывает состояние загрузки
- Обрабатывает ошибки
- Отображает thumbnail, если доступен
- Настраивает путь для стриминга видео

---

## Возможные ошибки и ограничения

### Ошибки подключения к БД

**Симптом:** Сообщение "Ошибка подключения" при загрузке страницы.

**Решение:**
- Проверьте настройки в `db/db_connect.php`
- Убедитесь, что PostgreSQL запущен
- Проверьте права доступа пользователя БД

### Ошибки сканирования

**Симптом:** Сканирование завершается с ошибкой.

**Возможные причины:**
- Нет путей для сканирования (добавьте через админ-панель)
- Нет прав на чтение директорий
- Превышен лимит времени выполнения (увеличьте `set_time_limit`)

### Проблемы с видео

**Симптом:** Метаданные видео не загружаются.

**Решение:**
- Убедитесь, что FFmpeg установлен
- Проверьте пути к `ffprobe` и `ffmpeg` в `api/get_video_metadata.php`
- Проверьте права на запись в директорию `thumbnails/`

### Ограничения

1. **Платформа:** Код ориентирован на Windows (пути, открытие папок через `fldr_open.php`)
2. **Кодировка путей:** Предполагается использование UTF-8
3. **Большие объёмы:** При сканировании очень больших директорий может потребоваться увеличение лимитов PHP
4. **Параллельные сканы:** Защита через сессии, но при использовании нескольких браузеров возможны конфликты

---








## Что можно улучшить в будущем

### Функциональность

1. **Автоматическое сканирование по расписанию** (cron-задачи)
2. **Многопоточное сканирование** для ускорения на больших объёмах
3. **Кэширование метаданных** для ускорения загрузки
4. **Экспорт данных** (CSV, Excel)
5. **Уведомления** о критических изменениях (email, Telegram)
6. **Версионирование файлов** (отслеживание изменений содержимого)
7. **Дубликаты файлов** (поиск одинаковых файлов по хешу)

### Безопасность

1. **Аутентификация пользователей** (сейчас отсутствует)
2. **Разграничение прав доступа** (админ, пользователь, гость)
3. **Защита от SQL-инъекций** (частично реализована через PDO, но стоит проверить все места)


### Производительность

1. **Индексы в БД** для ускорения запросов
2. **Оптимизация SQL-запросов** (JOIN, подзапросы)
3. **Кэширование результатов поиска**
4. **Ленивая загрузка** метаданных видео (только при открытии)

### Интерфейс

1. **Адаптивный дизайн** для мобильных устройств
2. **Тёмная тема**
3. **Drag & Drop** для загрузки файлов
4. **Графики статистики** (Chart.js, D3.js)
5. **Улучшенная визуализация** истории изменений

### Техническая часть

1. **Логирование** ошибок и действий
2. **Мониторинг** производительности
3. **Резервное копирование** БД
4. **Миграции БД** (версионирование схемы)
5. **Unit-тесты** для критичных функций

---

## Заключение

FileManager — функциональное решение для мониторинга и управления файлами. Система позволяет отслеживать изменения в файловой системе, управлять клиентами и просматривать метаданные видео. Проект использует современные технологии (PHP, PostgreSQL, JavaScript) и может быть расширен для решения более сложных задач.
